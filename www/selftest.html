<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Self-Test Tunnel Viewer (No TIFF)</title>
  <!--  Serve this page via http:// not file://  -->
  <style>
    body{font-family:Arial, sans-serif; margin:1rem; background:#202020; color:#ddd;}
    #glviewer-container{width:800px; height:500px; border:1px solid #555;}
    canvas{width:100%; height:100%; display:block;}
  </style>
  <!-- External libs for math -->
  <script src="https://cdn.jsdelivr.net/npm/gl-matrix@3.4.3/gl-matrix-min.js"></script>
</head>
<body>
<h2>Self-contained WebGL Tunnel Viewer Test</h2>
<p>This page bypasses TIFF parsing and feeds synthetic depth + reflectivity data directly into <code>viewer.js</code>. Check the browser console for progress messages.</p>
<div id="glviewer-container"></div>

<script type="module">
  // Import core modules (viewer + controls)
  import { Viewer } from './viewer.js';
  import { setupControls } from './controls.js';

  const log = (...args) => { console.log('[selftest]', ...args); };

  // 1. Generate synthetic data    /////////////////////////////////////////////
  const WIDTH = 72;   // angular divisions (columns)
  const HEIGHT = 40;  // 1-cm axial steps (rows)
  const depth   = new Uint16Array(WIDTH*HEIGHT);
  const reflect = new Uint16Array(WIDTH*HEIGHT);

  log('Generating synthetic data', {WIDTH, HEIGHT});

  for (let row=0; row<HEIGHT; ++row){
    for (let col=0; col<WIDTH; ++col){
      const idx = row*WIDTH + col;
      // depth (radius mm) : sine wave that slowly increases
      const theta = col/WIDTH * 2*Math.PI;
      const base  = 2000 + 200*Math.sin(theta*3 + row*0.2); // mm
      depth[idx] = base;    // fits in 16-bit (< 65k)

      // reflectivity : checkerboard pattern
      reflect[idx] = ((row>>2) & 1) ^ ((col>>2) & 1) ? 50000 : 10000;
    }
  }

  // 2. Build Viewer UI /////////////////////////////////////////////
  const container = document.getElementById('glviewer-container');
  const canvas = document.createElement('canvas');
  container.appendChild(canvas);
  canvas.tabIndex = 0; // enable key capture

  log('Creating Viewer instance …');
  const viewer = new Viewer(canvas, WIDTH, HEIGHT);
  canvas.viewer = viewer; // expose for console tinkering
  setupControls(canvas);

  log('Uploading synthetic data to GPU …');
  viewer.setData(depth, reflect, WIDTH, HEIGHT);
  viewer.render();
  log('Initial render complete. Interact with mouse + wheel or arrow keys.');
</script>
</body>
</html>